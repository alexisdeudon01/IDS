# Copilot instructions for IDS2 SOC Pipeline

## Big picture
- The pipeline is a Raspberry Pi 5 SOC stack: Suricata writes EVE JSON to /mnt/ram_logs, Vector transforms to ECS and bulk-ingests into AWS OpenSearch with Redis as fallback. See [python_env/modules/suricata_manager.py](python_env/modules/suricata_manager.py) and [python_env/modules/vector_manager.py](python_env/modules/vector_manager.py).
- The supervisor process in [python_env/agent_mp.py](python_env/agent_mp.py) spawns child processes for resource control, async connectivity checks (uvloop), metrics server, and a Flask API server; shared state is a multiprocessing `Manager().dict()`.
- Docker Compose runs the supporting stack (Vector, Redis, Prometheus, Grafana, API server). See [docker/docker-compose.yml](docker/docker-compose.yml).

## Configuration and secrets
- All settings come from [config.yaml](config.yaml) and are validated by `ConfigManager` in [python_env/modules/config_manager.py](python_env/modules/config_manager.py).
- Several config values are placeholders that must be provided via env vars (OPENSEARCH_MASTER_USER/PASS, GRAFANA_ADMIN_USER/PASSWORD, GIT_*). Placeholder resolution is in [python_env/modules/env_utils.py](python_env/modules/env_utils.py).
- Generated configs: [vector/vector.toml](vector/vector.toml) and [suricata/suricata.yaml](suricata/suricata.yaml) are auto-generated by `VectorManager` and `SuricataManager` and state “DO NOT EDIT MANUALLY”. Update [config.yaml](config.yaml) instead and regenerate via the agent.

## Workflows
- Run the agent directly: python3 python_env/agent_mp.py (see [README.md](README.md)).
- Docker stack: build with docker/build.sh, then docker-compose up -d from [docker/README.md](docker/README.md).
- Full deployment and tests are scripted in [deploy/deploy_and_test.sh](deploy/deploy_and_test.sh) and [deploy/run_all_tests.py](deploy/run_all_tests.py); these expect a .env file for environment variables.

## Project-specific conventions
- Resource limits are strict (≤70% CPU/RAM) and enforced by `ResourceController` in [python_env/modules/resource_controller.py](python_env/modules/resource_controller.py); any new background work should honor throttle levels.
- OpenSearch connectivity checks use DNS/TLS plus a bulk test in [python_env/modules/connectivity_async.py](python_env/modules/connectivity_async.py); failures update shared state keys like `aws_ready`, `dns_ok`, `tls_ok`.
- Git auto-commit/push is part of the pipeline workflow (`GitWorkflow` in [python_env/modules/git_workflow.py](python_env/modules/git_workflow.py)) and expects the required branch from config.

## Integration points
- AWS OpenSearch uses boto3 with profile `moi33` by default (`AWSManager` in [python_env/modules/aws_manager.py](python_env/modules/aws_manager.py)).
- Vector’s OpenSearch sink currently disables TLS verification in generated config; be careful when changing this in [python_env/modules/vector_manager.py](python_env/modules/vector_manager.py).
- The Flask API UI uses templates/static in [python_env/templates](python_env/templates) and [python_env/static](python_env/static), wired in [python_env/modules/api_server.py](python_env/modules/api_server.py).
